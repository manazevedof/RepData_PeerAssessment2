---
title: "Impacts of weather related events: A case study of the USA"
author: "Mario Azevedo"
date: "Sunday, May 24, 2015"
output: html_document
---

###Synopsis
* Synopsis: Immediately after the title, there should be a synopsis which describes and summarizes your analysis in at most 10 complete sentences

###Data Processing

####Loading the libraries that will be used 
```{r,message=FALSE, warning=FALSE} 
require(data.table)
require(dplyr)
require(tidyr)
require(readr)
require(ggplot2)
require(stringr)
require(grid)
require(gridExtra)
```

####Downloading and reading the data
```{r,cache=TRUE,message=FALSE,warning=FALSE}
#download.file("https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2",
#              "repdata-data-StormData.csv.bz2")
data <- read.csv('repdata-data-StormData.csv.bz2')
#Reading a data file prepared from the "Storm Data Event Table"
type <- readLines('storm.txt')
data <- data.table(data)
nr1 <- nrow(data)
```

####Cleaning the data
```{r}
data[data$EVTYPE == "TSTM WIND"]$EVTYPE <- "THUNDERSTORM WIND"
data[data$EVTYPE == "THUNDERSTORM WINDS"]$EVTYPE <- "THUNDERSTORM WIND"
data[data$EVTYPE == "MARINE TSTM WIND"]$EVTYPE <- "MARINE THUNDERSTORM WIND"
data[data$EVTYPE == "MARINE THUNDERSTORM WINDS"]$EVTYPE <- "MARINE THUNDERSTORM WIND"
data <- filter(data,EVTYPE %in% type)
perc1 <- 100*nrow(data)/nr1
```

####Preparing data for first question
```{r,message=FALSE}
totFat <- sum(data$FATALITIES,na.rm=TRUE)
totInj <- sum(data$INJURIES,na.rm=TRUE)
harm <- group_by(data,EVTYPE) %>% 
        summarise(NofEV=n(),Fatalities = sum(FATALITIES),
                  pFat= 100* sum(FATALITIES) / totFat,
                  Injuries=sum(INJURIES),
                  pInj= 100* sum(INJURIES) / totInj,
                  sevIndex = (10*sum(FATALITIES)+sum(INJURIES))) 
len <- nrow(harm)
harm$rankF <- len - ave(harm$Fatalities,FUN=rank) + 1
harm$rankI <- len - ave(harm$Injuries,FUN=rank) + 1
harm$rankS <- len - ave(harm$sevIndex,FUN=rank) + 1
```

####Preparing data for second question
```{r,message=FALSE}
data <- mutate(data,PROPDMGEXP = str_to_upper(str_trim(PROPDMGEXP))) %>% 
        filter(PROPDMGEXP %in% c('K','M','B','')) 
any <- data[PROPDMGEXP == 'K',PROPDMG:=PROPDMG/1000]
any <- data[PROPDMGEXP == 'B',PROPDMG:=PROPDMG*1000]
data <- mutate(data,CROPDMGEXP = str_to_upper(str_trim(CROPDMGEXP))) %>% 
        filter(CROPDMGEXP %in% c('K','M','B',''))
any <- data[CROPDMGEXP == 'K',CROPDMG:=CROPDMG/1000]
any <- data[CROPDMGEXP == 'B',CROPDMG:=CROPDMG*1000]
perc2 <- 100*nrow(data)/nr1

totPdmg <- sum(data$PROPDMG,na.rm=TRUE)
totCdmg <- sum(data$CROPDMG,na.rm=TRUE)
econ <- group_by(data,EVTYPE) %>% 
        summarise(NofEV=n(),
                  PropDmg = sum(PROPDMG),
                  pPdmg = 100 * sum(PROPDMG) / totPdmg,
                  CropDmg=sum(CROPDMG),
                  pCdmg= 100 * sum(CROPDMG) / totCdmg,
                  TotDmg = sum(PROPDMG)+sum(CROPDMG)) %>%
        arrange(desc(PropDmg))

len <- nrow(econ)
econ$rankP <- len - ave(econ$PropDmg,FUN=rank) + 1
econ$rankC <- len - ave(econ$CropDmg,FUN=rank) + 1
econ$rankT <- len - ave(econ$TotDmg,FUN=rank) + 1
```

* There should be a section titled Data Processing which describes (in words and code) how the data were loaded into R and processed for analysis. In particular, your analysis must start from the raw CSV file containing the data. You cannot do any preprocessing outside the document. If preprocessing is time-consuming you may consider using the cache = TRUE option for certain code chunks.

###Results
* There should be a section titled Results in which your results are presented.  
* You may have other sections in your analysis, but Data Processing and Results are required.  
* The analysis document must have at least one figure containing a plot.  
* Your analyis must have no more than three figures. Figures may have multiple plots in them (i.e. panel plots), but there cannot be more than three figures total.  
* You must show all your code for the work in your analysis document. This may make the document a bit verbose, but that is okay. In general, you should ensure that echo = TRUE for every code chunk (this is the default setting in knitr).  


####Results 1 
```{r}
result1 <- arrange(harm,rankF)[1:10] %>% 
        mutate(EVTYPE = str_to_lower(EVTYPE))
ord1 <- reorder(result1$EVTYPE,result1$Fatalities)
p1 <- ggplot(result1,aes(x=ord1,y=Fatalities)) + 
        geom_bar(stat="identity",position="dodge",fill="red",color="black") + 
        theme(axis.text.x=element_text(colour="black")) +
        theme(axis.text.y=element_text(colour="black")) +
        theme(axis.title=element_text(size=12)) +
        xlab("") + 
        ylab("Fatalities") +
        coord_flip()

result2 <- arrange(harm,rankI)[1:10] %>% 
        mutate(EVTYPE = str_to_lower(EVTYPE))
ord2 <- reorder(result2$EVTYPE,result2$Injuries)
p2 <- ggplot(result2,aes(x=ord2,y=Injuries)) + 
        geom_bar(stat="identity",position="dodge",fill="yellow",color="black") + 
        theme(axis.text.x=element_text(colour="black")) +
        theme(axis.text.y=element_text(colour="black")) +
        theme(axis.title=element_text(size=12)) +
        xlab("") + 
        ylab("Injuries") +
        coord_flip()

result3 <- arrange(harm,rankS)[1:10] %>% 
        mutate(EVTYPE = str_to_lower(EVTYPE))
ord3 <- reorder(result3$EVTYPE,result3$sevIndex)
p3 <- ggplot(result3,aes(x=ord3,y=sevIndex)) + 
        geom_bar(stat="identity",position="dodge",fill="orange",color="black") + 
        theme(axis.text.x=element_text(colour="black")) +
        theme(axis.text.y=element_text(colour="black")) +
        theme(axis.title=element_text(size=12)) +
        xlab("") + 
        ylab("Fatalities x 10 + Injuries") +
        coord_flip()

grid.arrange(p1, p2, p3, ncol = 1, 
             main = "Figure 1: Greatest Population Health Consequences",
             widths = unit(c(16), "cm"),
             heights = unit(c(5,5,5), "cm"),
             just=c("top"))
```

####Results 2
```{r}
result1 <- arrange(econ,rankP)[1:10] %>% 
        mutate(EVTYPE = str_to_lower(EVTYPE))
ord1 <- reorder(result1$EVTYPE,result1$PropDmg)
p1 <- ggplot(result1,aes(x=ord1,y=PropDmg)) + 
        geom_bar(stat="identity",position="dodge",fill="red",color="black") + 
        theme(axis.text.x=element_text(colour="black")) +
        theme(axis.text.y=element_text(colour="black")) +
        theme(axis.title=element_text(size=12)) +
        xlab("") + 
        ylab("Property Damage (10^6 US$)") +
        coord_flip()

result2 <- arrange(econ,rankC)[1:10] %>% 
        mutate(EVTYPE = str_to_lower(EVTYPE))
ord2 <- reorder(result2$EVTYPE,result2$CropDmg)
p2 <- ggplot(result2,aes(x=ord2,y=CropDmg)) + 
        geom_bar(stat="identity",position="dodge",fill="orange",color="black") + 
        theme(axis.text.x=element_text(colour="black")) +
        theme(axis.text.y=element_text(colour="black")) +
        theme(axis.title=element_text(size=12)) +
        xlab("") + 
        ylab("Crop Damage (10^6 US$)") +
        coord_flip()

result3 <- arrange(econ,rankT)[1:10] %>% 
        mutate(EVTYPE = str_to_lower(EVTYPE)) %>% 
        gather(type,value,c(PropDmg,CropDmg))
ord3 <- reorder(result3$EVTYPE,result3$TotDmg)
cols <- c(PropDmg="red",CropDmg="orange")
p3 <- ggplot(result3,aes(x=ord3,y=value,fill=type)) + 
        geom_bar(stat="identity",barposition="stack",color="black") + 
        theme(axis.text.x=element_text(colour="black")) +
        theme(axis.text.y=element_text(colour="black")) +
        theme(axis.title=element_text(size=12)) +
        xlab("") + 
        ylab("Property + Crop Damage (10^6 US$)") +
        coord_flip() +
        scale_fill_manual(values=cols,labels=c("Property","Crop")) +
        theme(legend.position=c(.8,.5),
              legend.title=element_blank(),
              legend.background = element_rect(color = "grey80", 
                                               fill = "grey90", 
                                               size = .5, 
                                               linetype = "solid"))

grid.arrange(p1, p2, p3, ncol = 1, 
             main = "Figure 2: Greatest Economic Consequences",
             widths = unit(c(16), "cm"),
             heights = unit(c(5,5,5), "cm"),
             just = c("top"))
```

